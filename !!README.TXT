===== 2009-01-13
Добавлена возможность смотреть историю команд, данных боту - !commandhistory.
Синтаксис: !commandhistory {command | id | nick} [limit]
  command - название команды бота (например, reg).
  id - ID записи в таблице.
  nick - ник пользователя.
  limit - максимальное число записей для показа.
Примеры:
  * История команды reg: !commandhistory reg
    Формат вывода: ID записи - время - номер игры - ник - аргументы
  * История команд юзера Вася: !commandhistory Вася
    Формат вывода: ID записи - время - номер игры - команда аргументы
  * История записи 12345: !commandhistory 12345
    Формат вывода: ID записи - время - номер игры - ник - команда аргументы

Новые команды (COMMANDS):
* !commandhistory

Новые сообщения (MESSAGES):
* command_history_is_empty
* no_such_command_history_entry_id

Новые настройки бота (SETTINGS):
* max_command_history_lines = 20; 5; максимальное количество записей, выводимых командой !commandhistory


Бот рассылает админам уведомление о факте использования команды !raw.
Новые настройки бота (SETTINGS):
* notify_admins_on_raw_usage = yes|no; 5; уведомлять ли админов о факте использования команды !raw
Новые сообщения (MESSAGES):
* user_used_raw_command_notice


Можно снять ограничение на минимальную цену артефакта (барыга сможет продавать
артефакты дешевле их минимальной цены).
Новые настройки бота (SETTINGS):
* enable_min_artifact_price_restriction = yes|no; 3; барыга может продавать артефакты дешевле их минимальной цены
Новые сообщения (MESSAGES):
* you_must_specify_artifact_price



===== 2009-01-11
Добавлена авто-идентификация у бота юзеров, авторизованных у никсерва.
Пользователь настраивает (включает/выключает) авто-идентификацию с помошью
команды !myautoid:
  * Включить авто-идентификацию: !myautoid yes
  * Выключить авто-идентификацию: !myautoid no

Уведомления об авторизации юзеров у никсерва бот получает от специального
сервиса. Уведомления приходят в следующих ситуациях:
  * Бот зашел на игровой канал.
  * Авторизованный у никсерва юзер зашел на игровой канал.
  * Юзер, находящийся на игровом канале, авторизовался у никсерва.

Формат уведомления:
  * Авторизация: "+r ник_юзера_в_IRC номер_ника_в_базе_NickServ"
  * Снятие авторизации: "-r ник_юзера_в_IRC номер_ника_в_базе_NickServ"

Чтобы отключить авто-идентификацию в боте, надо задать пустую строку
в параметре nickserv_notice_service.

Новые настройки бота (SETTINGS):
* nickserv_notice_service = ; 5; полный адрес (ник!идент@хост), с которого приходят уведомления об идентификации на ник у никсерва (+r, -r)
* auto_authorize_registered_nicks = no|yes; 4; автоматически идентифицировать у бота юзеров, идентифицировавшихся на ник у никсерва

Новые команды (COMMANDS):
* !myautoid

Новые сообщения (MESSAGES):
* authorize_yourself_at_nickserv_before_turning_autoid_on

Новые поля в базе:
USERS.auto_identify integer not null default 0 comment 'Идентифицировать ли автоматически у бота, если юзер авторизован у никсерва.';
USERS.nickserv_id integer not null default 0 comment 'ID ника в базе никсерва (выводится в /ns info), закрепленный за этим ником.';



===== 2009-01-09
Команда !recruite переделана из игровой в ролевую.
Новые команды ролей: recruiteB, recuiteC, recruiteF, recruiteR, recruiteX.

Команды !use и !forcevote переделаны из игровых в ролевые.
Новые команды ролей: useT, forcevoteT.

Новые поля в БД:
ROLES_COMMANDS.is_regular int not null default 1
  comment 'Является ли команда ночным ходом (true) или идет в дополнение к нему (false).'.


Бот отслеживает статус away пользователей игрового канала (раз в минуту шлет /WHO #игровой_канал).
Бот не рассылает персональный нотис о начале регистрации в игру пользователям,
у которых установлен статус away.
Бот не упоминает ники пользователей, у которых установлен статус away, в
общеканальном нотисе "До конца регистрации осталась одна минута".

Новые настройки бота (SETTINGS):
away_track = yes|no; 4; отслеживать ли статус away пользователей игрового канала
away_track_max_users = 100; 4; максимальное число пользователей на игровом канале, при котором бот отслеживает их статус away



===== 2009-01-06
Добавлено: бот шлет нотис на разговорный канал (#mafion.talks), когда
начинается регистрация в игру.
Новые настройки бота (SETTINGS):
notify_talks_channel_on_reg_start = yes|no; 2; слать ли нотис на талксы, когда начинается регистрация в игру

Изменено: в качестве адреса клона (!addclone) можно указывать маску.
Специальные символы в маске: * - ноль или более символов, ? - один любой символ.



===== 2008-09-03
Новая роль - ТЕРРОРИСТ:
1. Берет игрока в заложники (!take). Заложник сидит в яме, блеет от страха
   и не может ходить ночью и делать покупки в магазине.

   Убивает заложника (!kill).

   Прикрывается заложником от покушений (!use):
   *) от одного покушения за ночь на первом и втором уровнях.
   *) ото всех покушений за ночь на уровне 3+, до тех пор, пока в заложника не
      попадет бомба мафов. После попадания бомбы заложник рассыпается в труху
      и больше не защищает террориста.
   Если террориста пытаются убить, то погибает заложник, а покушавшийся
   получает минус.
   Эта команда НЕ считается ночным ходом (заказом), а идет в дополнение к нему.
   Синтаксис: !use nick | cancel
     *) Прикрыться заложником: !use nick
     *) Отменить прикрытие:    !use cancel

   Девка не отменяет заказ (фича nofuck).
2. Ставит растяжку у дома игрока (!mine). Игрок погибает, если сделал успешный
   ход ночью (т.е. ход не отменился утром).
3. 2 + погибает заказавший игрока, у дома которого стояла растяжка (т.е. как
   вуду у маньяка).
4. Принуждает заложников голосовать за определенного игрока (!forcevote).
   Не подчинившиеся заложники наказываются.
   Голоса НЕ учитываются в случае линча.
   Заложники НЕ получают денег за казнь - они отдаются террористу.
   Эта команда НЕ считается ночным ходом (заказом), а идет в дополнение к нему.
   Синтаксис: !forcevote {nick {yes | no | whoknows}} | !night | cancel
     *) Заказ игрока:  !forcevote nick {yes | no | whoknows}
     *) Заказ ночи:    !forcevote !night
     *) Отмена заказа: !forcevote cancel

Заложников можно выкупать (!free). Заложник освобождается утром автоматически,
если сумма выкупа достигнет суммы, заработанной заложником за игру.
Синтаксис: !free nick {money | {0 | cancel}}
   *) Предложить выкуп: !free nick money
   *) Отменить выкуп:   !free nick 0 или !free nick cancel

Если террориста казнят, то все заложники погибают.
Если террориста убивают, то все заложники освобождаются.
Заложники недосягаемы для заказов других игроков, т.е. заказ уходит в никуда
(как заказ катана в сортире).

Роли, кроме барыги и мирных, могут пропускать ночной ход командой !skip.

Новые команды ролей (таблицы ROLES_COMMANDS, ROLES_COMMANDS_ALIASES, COMMANDS):
  Террорист: !take (takeT), !kill (killT), !mine (mineT), !forcevote, !use.
  ВСЕ роли, кроме барыги и мирного жителя: !skip (skip?).
  ВСЕ роли: !free.

Новые фичи ролей (ROLE_FEATURES, ROLES_FEATURES):
* nofuck - защита от девичьей страсти: заказ не отменяется.

Новые сообщения (MESSAGES):
* you_cant_take_yourself_as_hostage
* wrong_time_for_using_hostage
* you_cant_use_yourself_as_cover
* terrorist_takes_you_as_hostage
* you_force_hostages_to_vote_yes
* you_force_hostages_to_vote_no
* you_force_hostages_to_vote_whoknows
* you_force_hostages_to_vote_for_night
* you_canceled_forced_voting
* terrorist_forces_you_to_vote_yes
* terrorist_forces_you_to_vote_no
* terrorist_forces_you_to_vote_whoknows
* terrorist_forces_you_to_vote_for_night
* terrorist_doesnt_force_you_to_vote_anymore
* hostages_cant_act
* you_are_not_hostage_anymore
* you_are_redeemed_from_terrorist
* you_can_use_only_hostages
* you_can_kill_only_hostages
* won_tx
* hostage_list
* hostage_list_is_empty
* wrong_time_to_force_vote
* your_redeem_offer_accepted
* you_canceled_your_redeem_offer
* you_have_not_enough_money_for_redeem_offer

Новые фразы (PHRASES), минус означает, что фразы еще не написаны:
+ T:take (террорист захватил заложника)
+ T?:dead (заложник умер из-за казни террориста)
+ T?:kill (террорист убил заложника)
- T?:mine (сработала растяжка террориста)
  Валидные переменные для использования в тексте фразы:
  $KILLEDPLAYER - ник убитого.

- T?:mine2 (сработали осколки растяжки террориста)
  Валидные переменные, доступные для использования в тексте фразы:
  $KILLEDPLAYER - ник убитого.

- T:mine_nothing (растяжка террориста не сработала)
  Валидные переменные, доступные для использования в тексте фразы:
  $VICTIM - ник игрока, которому была поставлена растяжка.

+ ?:hostage_not_reachable (? - кроме T) (заказали заложника)
  Валидные переменные, доступные для использования в тексте фразы:
  $VICTIM - ник заказанного заложника.

+ takeTg:failed (телохранитель помешал террористу взять заложника)
  Валидные переменные, доступные для использования в тексте фразы:
  $VICTIM - ник заказанного игрока, которого террорист пытался взять в
  заложники.

- mineTd:failed (доктор спас от растяжки)
  Валидные переменные, доступные для использования в тексте фразы:
  $VICTIM - ник жертвы растяжки.

- mineTg:failed (телохранитель спас от растяжки)
  Валидные переменные, доступные для использования в тексте фразы:
  $VICTIM - ник жертвы растяжки.

- mineT2d:failed (доктор спас от осколков растяжки)
  Валидные переменные, доступные для использования в тексте фразы:
  $VICTIM - ник жертвы осколков растяжки.

- mineT2g:failed (телохранитель спас от осколков растяжки)
  Валидные переменные, доступные для использования в тексте фразы:
  $VICTIM - ник жертвы осколков растяжки.

- ?T:used_hostage (террорист успешно прикрылся заложником)
  Валидные переменные, доступные для использования в тексте фразы:
  $KILLEDPLAYER - ник убитого заложника.

- hostage_redeemed (выкупили заложника террориста)
  АХТУНГ! Порядок переменных, доступных для использования в тексте фразы,
  жестко задан:
  @param [0] - $NICK - ник заложника.
  @param [1] - $NUMBER - сумма выкупа.

Новые очки (POINTS):
* T?:execute (казнь)
* T?:kill (убийство заложника)
* T?:mine (убийство растяжкой)
* T?:mine2 (убийство осколками растяжки)
* T?:take (? - кроме T) (взятие заложника)
* Td:failed (доктор помешал убить)
* Tg:failed (телохранитель помешал убить)
* TK:nolevel (не хватило уровня, чтобы убить киллера)
* TM:nolevel (не хватило уровня, чтобы убить маньяка)
* ?:kill_hostage (стреляли в террориста, а убили заложника)
* T:used_hostage (террорист успешно прикрылся заложником)

Новые подсказки ролям (PROMPTS):
* help_for_t?

Новые настройки бота (SETTINGS):
* max_skip_turn_count
* terrorist_forcevote_min_level
* terrorist_forced_voting_candidate_mismatch_penalty
* terrorist_forced_voting_yesno_mismatch_penalty

Тип параметра int actionCode метода Game::checkOrder() заменен на enum
OrderActionType.



===== 2007-09-18
Исправлено: забыл return в Game::getRoleCommandCount().
Круто, даааааа?!?!??!! А ведь говорил:
Надо
     переписать бота!
                      на нормальном!
                                     языке!
Чтобы компилятор отлавливал такую срань!
По-моему, своим ыыыыыыыыканьем и ржачем разбудил уже весь дом.


===== 2007-09-15
Исправлено: команда "!levels роль" показывала ноль команд.
Добавлено: int Game::getRoleCommandCount() для расчета числа
команд роли на уровне.


===== 2007-09-02
Изменено: при сплите бот восстанавливает сбитые приджойнившимся сервером моды
не только на игровом канале, но и моды юзеров (например, +v).


===== 2007-08-23
Исправлено: хулиган или член шайки убивали жертву, защищенную телохранителем.


===== 2007-03-30
Исправлена ошибка с подсветкой союзников для катана и бомжа.


===== 2007-03-24
Хулигану на первом уровне добавлена команда !spy.

Добавлена возможность выдавать права группам пользователей на ключи !setkey.
Новая команда: !groupkey.
Новые сообщения: you_cant_assign_config_key, acl_allowed_config_keys,
acl_denied_config_keys, acl_reset_config_keys, groupkey_rights,
groupkey_no_rights.
Новое в БД: SETTINGS_RIGHTS.may_assign integer not null default 0.
Если копипастить такими темпами, _game.pike скоро будет весить больше винды.

Исправлена ошибка кеширования прав на команды бота в loadCommandAccessRights().

Из _mafion.pike убраны неиспользуемые переменные:
string socket_buffer, array accesslist.

Ключи !setkey debug, skin и default_skin теперь экспортируются в базу, чтобы
их могли менять не только хостеры.


===== 2007-03-23
Исправлена ошибка с подсветкой союзников офиса, когда в офисе находится игрок,
приглашенный не ботом, а командой !invite. Свойство checkedRole класса Player
разделено на два свойства officeCheckedRole и logovoCheckedRole.


===== 2007-03-19
Добавлена стандартная группа "Хостеры" с кодом host. Ключи !setkey,
хранящиеся в файле mafion.cfg, а не в базе, могут менять только ее члены.

Добавлена возможность выдавать права группам пользователей на команды бота.
Новая команда: !groupcommand.
Новые сообщения: you_cant_assign_command, groupcommand_rights, 
groupcommand_no_rights.


===== 2007-03-11
Исправлена ошибка с подсветкой союзников: катану/бомжу раньше показывало
всех миров сразу.


===== 2007-03-10
Добавлена подсветка союзников в списке игроков (!players).
Новые ключи !setkey: hilight_allies = yes|no, color.ally_nick.


===== 2007-03-03
Исправление в LineBreaker::split().

В списке доступных команд бот пишет тип аргументов команды (ник, роль
или ничего), например:
Доступные команды: !novote (!nv), осталось: 1; !infect <ник/номер> 
(!in, !за, !заразить), осталось: 1; !seduce <ник/номер> (!fu, !сп, 
!спать), осталось: -неограничено-;
Новые сообщения: role_cmd_argtype_nick, role_cmd_argtype_role.

Исправлена ошибка с вербовкой в шайку: если в одну и ту же ночь миру 
предлагал завербоваться хулиган, и этого же мира проверял офис, то 
такой мир мог завербоваться в шайку _после_ проверки офисом, т.е.
уже будучи приглашенным в офис.
Пример. Хулиган предлагает завербоваться миру: !recruite Вася.
Миру добавляется mayChangeTeamTo += "X". Катан проверяет того же мира:
!check Вася. Наступает утро. При обработке хода катана бот приглашает
Васю в офис. А потом Вася решает присодиниться к шайке: !team x. Ему это
удается, поскольку при проверке офисом не была очищена переменная
mayChangeTeamTo.

Можно посмотреть сколько команд на каждом уровне есть у роли.
Новая команда: !skills [роль ...]
Формат вывода: название роли (код роли): команда (уровень) - число команд, ...
Новые сообщения: unknown_role_codes.


===== 2007-03-02
Добавлена задержка между отправкой IRC команд на сервер.
Используется для ботов, вылетающих из сети за флуд (Excess Flood).
Новый ключ !setkey:
# Делитель для расчета задержки в секундах между
# отправкой команд IRC на сервер.
# Используется для ботов без статуса иркопа,
# вылетающих из сети за флуд (Excess Flood).
# Чтобы отключить задержку, надо задать ноль.
# задержка = 1 + длина_команды_в_байтах / irc_command_delay_delimiter
irc_command_delay_delimiter = 0; 2; делитель для расчета задержки в секундах между отправкой команд IRC на сервер


===== 2007-02-25
Error:
Attempt to index the empty string with 0.
_events.pike:353: _mafion()->onText("p")
_irc.pike:254: _mafion()->irc->processMessage()
_irc.pike:100: _mafion()->irc->read_callback(0,":DIAVOL!rtr@87.253.210.57 PRIVMSG #Mafiozy :\3""4 \r\n")

_events.pike:353
БЫЛО:
      if (args[0] == '!') {
СТАЛО:
      if (strlen(args) > 0 && args[0] == '!') {


===== 2007-02-22
_game.pike:6956:
БЫЛО:
            s += sprintf("<number><bold> %d</bold><number>. <n>%s</n> - $<number>%s</number>",i+1,row[0],row[1]);
СТАЛО:
            s += sprintf("<number><bold> %d</bold><number>. <n>%s</n> - $<number>%s</number>",i+1,(string)row[0],(string)row[1]);


===== 2006-09-03
Исправление в Game::changeTeam(): отмена заказа мира, завербовавшегося
в шайку, делалась неправильно: удалялся только ник из ordersOrder. Из-за
этого бот не напоминал такому игроку сделать ход каждую минуту.
Удаление ника заменено на вызов cancelPlayerOrder().


===== 2006-09-01
Добавлено вырезание цветовых кодов из строк, полученных от сервера.
В лог/базу сохраняется оригинальная строка.
Цвета вырезаются из:
* названий команд бота/ролей
* аргументов ночных команд ролей, если аргументы - ник или код роли.
Цвета НЕ вырезаются из всего остального.
Новые файлы: _strip_colors.pike
В _mafion.pike добавлено #include "_strip_colors.pike".
В onText() в _events.pike добавлен вызов strip_colors() и переписан
разбор аргументов ночных команд ролей.

Исправление в Game::identifyUser(): раньше в случае успешной авторизации
простым игрокам писалось только "ок", а не простым (оп, техник и т.п.)
писалось "ок" и "Вы идентифицированы как..." Теперь не простым пишется
только "Вы идентицифированы как...", без "ок".


===== 2006-08-28
Исправление в Game::inviteMe(): дописан блок для хулигана.

Исправление в Game::changeTeam(): теперь бот предлагает свежезавербованному
миру сделать ход и показывает список доступных команд и игроков (вставлен
вызов Game::sendPromptForPunk()).

Исправление в Game::replacePlayer(): добавлена замена ника в вербовке
хулигана roles[ROLE_HOOLIGAN]->recruiteNick. Также вставлен вызов
Game::sendPromptForPunk().

Исправление в Game::recruite(): предыдущее предложение хулигана
не отменялось, если текущий игрок, которому предлагают завербоваться,
не мог быть завербован в шайку. Можно было вычислять роли нахаляву.


===== 2006-07-24
Исправлена ошибка "нет такого игрока" при заказе существующего игрока.


===== 2006-07-19
Исправлена ошибка с вербовкой хулигана: при вербовке одного игрока больше
одного раза (!re ник, !re ник подряд), бот говорил, что тот не был приглашен
в команду в ответ на !team x.


===== 2006-07-17
Добавлена возможность редактировать игровые фразы бота.
Новые команды: !addphrase, !delphrase, !initpharse, !setphrase.
Новые сообщения: no_such_phrase_id, ambiguous_phrase_key, phrase_info,
phrase_reinited_by.
Новые поля в таблице PHRASES: ovr, user_id.

Добавлены недостающие игровые фразы: killBcomplete, killBcompleteandkill,
killBcompleteandopennick.

Канал шайки хулигана прописан в источники применения (COMMANDS.source)
нужным командам.


===== 2006-07-15
Подсказки ролям (help_for_*) выдаются, начиная с первого, а не второго уровня.
В базу добавлены подсказки для миров 4 уровня, хулигана и членов шайки.

Изменения в Game::anybodyWon(): для убивающих ролей учитывается невозможность
убить из-за пропуска хода из-за хулигана.
Слабонервным в код не смотреть. Кто предложит учитывать в Game::roleCanKill()
возможное повышение уровня игроков из-за !getmoney, возможное блокирование
одной из убивающих ролей артефактом, невозможность убить маньяка/киллера/девку
из-за нехватки уровня/автопротекта/repeatOrder, возможный сплит или что-нибудь
в этом духе, берет барабан, строится в колонну по одному и с песнями-плясками,
взявшись за руки, дружно отправляется в пешее эротическое. Или присылает патч.
Аминь.


===== 2006-07-07
Исправлена ошибка с доктором: на втором уровне он лечил от вуду, но погибал сам.


===== 2006-07-05
Протект катана защищает от хулигана и шайки.


===== 2006-04-30
Исправление в Game::anybodyWon() в критериях победы шайки хулигана.


===== 2006-04-25
В деме телохранитель может заказывать себя в первую ночь.


===== 2006-04-19
Исправлена ошибка в SQL-запросе Game::listClones(): не показывало клонов,
добавленных операторами, удаленными из таблицы USERS.


===== 2006-04-17
Исправлена ошибка с возвратом войса вернувшимся игрокам.


===== 2006-04-15
Исправление в Game::cancelNightCommand():
БЫЛО:
  if (p->role != ROLE_CITIZEN && p->role != ROLE_DEALER)
СТАЛО:
  if (p->role != ROLE_CITIZEN && p->role != ROLE_DEALER && p->role != ROLE_PUNK)

Исправление в Game::replacePlayer():
БЫЛО:
  if (gameStatus == VOTE) {
    ...
    showCandidates();
  }
СТАЛО:
  if (gameStatus >= VOTE && gameStatus <= FINALCANDIDATESPEECH) {
    ...
    if (gameStatus == VOTE) { showCandidates(); }
  }
Может, вообще выкинуть этот блок? Все равно заменяться можно только ночью.


===== 2006-04-12
Добавлены скобки в Game::setUserTitle():
  help(op_nick, "usertitle" + (title_type == TITLE1 ? "1" : "2"));

Многоэтажные if'ы анализа ACLE_* кодов заменены на вызов getACLErrorMessage().

В деме мафы могут убивать союзников.

Исправлена ошибка с хулиганом и телохранителем: ход хулигана, не показывался
на канале, если жертву защитил телохранитель.


===== 2006-03-30
Исправление в Game::sendPromptForPunk(): добавлена проверка уровня
игрока и наличия команд роли в текущей игре (levelCounters), исправлены
опечатки (sinonimes).
Опечатку нашел совершенно случайно, просто краем глаза зацепился, потому
что дико выглядит. Никто не хочет переписать бота на каком-нибудь более
нормальном языке?


===== 2006-03-29
Исправлены ошибки с хулиганом при вычислении победителя в anybodyWon().

Исправлена ошибка со счетчиком повторов заказанных ников в morning().
Расстановка повторов ников перенесена ПОСЛЕ проверки хода хакера.
Пример. Овердоз наступает на третьем разе. Доктор вхолостую лечит Васю два
раза подряд и заказывает его в третий раз. НО на третий раз хакер сбивает
доктору ход, и тот лечит Колю. Коля умирает от овердоза, потому что
кол-во повторов посчитано для Васи.

Команда !allies показывает союзников шайки хулигана.

Исправление в выборе ходящего мафа: предпочтение отдается игрокам,
находящимся в игре (alive == 10).

Ходы шайки транслируются на канале шайки.

Убраны выборы нового хулигана при смерти старого.

Возможность убивать дружественные роли настраивается.
Новый ключ !setkey: kill_allies = no|yes

Игроки, вышедшие с канала во время игры, автоматически добавляются в список
замен.
Новый ключ !setkey: auto_replace_on_part = yes|no


===== 2006-03-20
Исправлена ошибка с Каттани: киллера можно было убить только командой !killrole.

На дневном голосовании бот не ждет игроков, пропускающих голосование.


===== 2006-03-19
Изменения у хулигана:
* Вербовка доступна с первого уровня.
* Мирные жители, приглашенные в офис, не могут завербоваться в шайку.
* Члены шайки выглядят мирными жителями для офиса Каттани.
* У избитых игроков НЕ отбирает войс.


===== 2006-02-12
Исправлена ошибка в saveArtifact: в форматной строке sprintf не хватало 's' после '%'.


===== 2006-02-05
Добавлен логгинг на канале шайки хулигана (по аналогии с логовом и офисом).


===== 2006-02-02
Новые роли - хулиган и член шайки.
Хулиган:
1. Избивает игрока. Избитый не может голосовать днём.
2. Избивает игрока. Избитый не может голосовать днём и ходить ночью. Девойс на сутки.
3. Вербует мирных, хакера и девку в свою шайку.
4. Убивает.

Член шайки (бывший мирный):
3. Избивает игрока. Избитый не может голосовать днём и ходить ночью.
4. 3 + девойс на сутки;
   Могут убивать все сразу (как мафы 4-го уровня).

По дороге пофиксены какие-то старые баги.


===== 2006-01-31
При подсчете победителей бомж с командой kill и тело, начиная с 3 уровня, приравнены к убивающим ролям.
Изменения в anybodyWon()

Вербовать в логово могут все игроки, принадлежащие к TEAM_MAFIOSI
Изменения в checkOrder() и recruit()

Проверяющим ролям не пишут результат проверки, если они нарвались на протект маньяка
Изменения в checkOrder() 

Исправлены ошибки про раздаче ролей в демках
Изменения в setDemoRoles() и checkRoles() 



===== 2006-01-09
Фичи ролей теперь настраиваются, а не жестко зашиты в коде.

Коды и описания существующих фич:
* noexec - защита от казни.
* novoodoo2 - защита от voodoo2 (роль не умирает при заказе проклятого маньяком).
* noinfect - защита от СПИДа.
* nohack - хакер не сбивает заказ.

Новые таблицы:
ROLE_FEATURES - описания фич ролей.
ROLES_FEATURES - распределение фич по ролям.

Новый метод в классе Roles: boolean hasFeature().

Новый параметр у команды !setrole: features = {[+]фича:уровень | -фича} [...]
Добавляет/удаляет фичу роли.

Новые команды: !rolefeatures - показывает список существующих в природе фич.

Новые сообщения: invalid_feature_syntax.


Исправлена ошибка с заказами телохранителя и киллера:
<влюбленная> [03:22:22] влюбленная: !go 11 15
<влюбленная> [03:22:22] Mafion: Ваш заказ принят!
<влюбленная> [03:22:40] Mafion: Наступила кровавая ЗАРЯ. Ничего не подозревающие жители ещё не читали утренних газет...
<влюбленная> [03:22:46] влюбленная: !go 11 1
<влюбленная> [03:22:46] Mafion: Ваш заказ принят!
<влюбленная> [03:23:28] Mafion: Телохранитель сегодня охранял сон товарища влюбленная! (Телохранитель: +5)
<влюбленная> [03:23:28] Mafion: Дополнительно от заказчиков телохранитель получает 1$!
<влюбленная> баг в том, что день уже наступил :)


===== 2006-01-08
Версия 0.15.

Исправлена ошибка в Game::checkBlockedHost(): забыл проверять, если юзер на
канале и получалось NPE из-за этого, если юзера нет на канале,
а checkBlockedHost() вызывается из-за !adduser.

При замене вошедший получает номер выбывшего игрока.

Четвертый уровень у мирных жителей. Можно ночью шпионить за игроком.
Если игрок ходил ночью, то утром бот напишет миру в приват: "Вы видели, что
у Васи всю ночь горел свет".
Если игрок НЕ ходил ночью, то утром бот напишет миру в приват: "Вы всю ночь
пристально наблюдали за домом Васи, но так ничего и не увидели."
Новые команды роли: !spy.
Новые сообщения: spy_action, spy_nothing.

Четвертый уровень у барыги: пассивная защита от казни.

Исправлена ошибка с хакером, которого поимела девка: раньше на канале писалось,
кого он хакнул, даже если с ним спала девка.

Исправлена ошибка с экспортом: раньше не экспортировались названия артефактов.

Изменения в структуре таблиц для хранения измененных значений по аналогии
с mafion.cfg и mafion.ovr.
Новые поля в таблицах: ovr, user_id.
Измененные таблицы (в скобках указаны изменения в полях помимо
указанных в "Новых полях", "+" - поле добавлено, "-" - удалено):
ARTIFACTS
ARTIFACTS_ALIASES (+art_code, -artifactID)
ARTIFACTS_NAMES (+art_code, -artifact_id)
MESSAGES
PIECES
POINTS
PROMPTS
ROLES
ROLES_COMMANDS (+role_code, -role_id)
ROLES_LEVELS (+role_code, -role_id)
ROLES_NAMES (+role_code, -role_id)

Новые команды: !initartifact, !initkey, !initmessage, !initpieces, !initpoints,
!initprompt.
Новые сообщения: artifact_reinited_by, setkey_reinited_by, message_reinited_by,
pieces_reinited_by, points_reinited_by, prompt_reinited_by.

Изменения в команде !levels: если указать код роли, то будет показано кол-во
команд роли на разных уровнях.
Пример: !levels R - кол-во команд у журналиста.
Новые сообщения: level_counters.


===== 2006-01-06
Исправлена ошибка с "бесконечными" инвайтами у бомжа: забыл обнулять кол-во
инвайтов в начале игры в void meetRoles(), поэтому они накапливались в течение
всех игр.


===== 2006-01-02
Снова возвращаясь к throttled. :)
Новый ключ !setkey: throttled_message = (Throttled:; 5; сообщение, выдаваемое IRC сервером, если мы throttled.
Этот ключ НЕ экспортируется в базу.

<eleven> Писать бота надо трезвым, радостным и бездельным 8-)
Золотые слова, в который раз убеждаюсь. :)

Исправлена ошибка с ночными командами ролей: раньше их можно было давать
на канале, и бот принимал их.


===== 2006-01-01
Исправлена ошибка с подставой роли:
<Mafion> Эх, жители, жители, что же вы забыли про подставу? Благодаря адвокату вместо Люблю_Заллдона сегодня на виселице болтается $SUBSTITUTEDNICK! (Адвокат: $50)
БЫЛО:
         if (attorneyCommand == "substituteroleA") { attorneyCommand = "substituteA"; }
СТАЛО:
         if (attorneyCommand == "substituteroleA") {
            players[roles[ROLE_ATTORNEY]->nick]->orderCommand = attorneyCommand = "substituteA";
         }
Подробности в Irc::parseMessage() в блоке if (players[roles[ROLE_ATTORNEY]->nick] ...

Исправлена ошибка в Game::initRole(): метод void saveRole() был перенесен
в файл _config.pike, а в initRole() вызов остался старым: game->saveRole().


===== 2005-12-31
Исправлена ошибка в Game::getMoney(): в деме проверялось наличие денег на счету
игрока.


===== 2005-12-30
Возвращаясь к ERROR :Closing Link: [81.211.38.70] (Throttled: Reconnecting too fast)
Добавлен новый ключ: throttled_reconnect_delay = 90; 5; интервал в секундах между попытками соединиться с IRC сервером, если throttled (получен отлуп из-за слишком большого кол-во коннектов за маленькое время)
Этот ключ НЕ эскпортируется в базу.
Новый метод int getReconnectDelay() в классе Irc. Выбирает нужный интервал
в зависимости от состояния IRC клиента: throttled или нет.


===== 2005-12-28
Фраза отказа от роли теперь пишется.


===== 2005-12-26
2005-12-12 23:51:42 ERROR :Closing Link: [81.211.38.70] (Throttled: Reconnecting too fast)

_events.pike:47
БЫЛО:
      irc->connect(settings["server"]->value,settings["port"]->value);
СТАЛО:
      // Если это коннект после дисконнекта, игра начинается заново
      gameStatus = STOP; 
      mixed err = catch {
         game->stopAllTimers();
      };
      if (err) {
         logError(sprintf("onDisconnect: game->stopAllTimers() failed: %s", describe_backtrace(err)));
      }

      call_out(irc->connect, (int)settings["connectiondelay"]->value, settings["server"]->value, settings["port"]->value);


===== 2005-12-23
Игроки, пропустившие голосование больше допустимого числа раз, будут удалены
из игры по аналогии с ролями, пропустившими свой ход.
Новый ключ !setkey: max_votings_passed = 4; 3; максимальное количество пропусков голосований
Чтобы отключить, надо задать 0 (ноль).


===== 2005-12-18
Исправлена ошибка в Game::replacePlayer(): забыл устанавливать статус (alive)
заменившего игрока в 10.


===== 2005-12-17
Исправлена ошибка в Game::identifyUser(): забыл db->quote() при вставке
в LOGON_HISTORY.

Исправлена м-м-м ладно, пусть будет ошибка с !rehash: добавлена проверка,
что можно и нельзя рехашить во время игры. Роли и артефакты - НЕЛЬЗЯ!

Исправлена ошибка в Game::regUser(): при регистрации нового юзера,
проиденченного на существующий аккаунт, группы задавались не новому игроку,
а тому, на которого проидентился юзер.
Пример. Юзер Кеша не зареган в базе. Он идентится как zalldone: !id zalldone
password. После этого регистрирует свой собственный ник: !reg password. В итоге
при регистрации юзеру zalldone будет установлена группа "Игроки", а новому
юзеру Кеша не будут установлены группы вообще.
_game.pike:4181:
БЫЛО:
      // Добавить пользователя в группу игроков.
      int rc = setUserGroups(nick, (< userGroups[UGC_USERS]->id >));
СТАЛО:
      // Добавить пользователя в группу игроков.
      int rc = setUserGroups("@" + nick, (< userGroups[UGC_USERS]->id >));
Подробности в описании int getUserIDByNick() в _acl.pike.


===== 2005-12-06
Исправлена ошибка с телохранителем и киллером: при выполнении заказа
НЕ очищался заказанный ник, т.е. заказ оставался в силе.

Исправлена ошибка с повтором ников: счетчик увеличивался даже если девка
отменяла ход игроку.

Исправлена ошибка с ником при обработке ходов телохранителя: во фразах с
ключами killG?:failed было $VICTIM, а надо $ORDERNICK.

Исправлены ошибки с маном в сортире: девка теперь не заражает и не ворует
деньги; хакер теперь не ворует деньги.


===== 2005-11-30
Можно задать номер ночи, начиная с которой доступна команда !getmoney.
Новый ключ !setkey: getmoney_night = 2

Добавлены бесконечные отказы от ролей.
Новое поле в таблице USERS: unlimited_role_rejects
Новое свойство в классе User: boolean unlimitedRoleRejects = false;


===== 2005-11-25
Исправлена ошибка с показом несходивших ролей в Game::showTurnsLeft():
вылетевшую роль (alive == 13) не показывало в списке.

В Game::checkUserLevel() добавлена отмена ночного заказа из-за нехватки уровня:
игрок мог сначала сделать ход, потом купить у барыги, съехать на уровень вниз,
а ночная команда более высокого уровня не отменялась.
Пример: маньяк второго уровня говорит !voodoo, затем покупает презик и из-за
покупки опускается на первый уровень.

Исправлена ошибка в Game::completeShopOrder() при выполнении заказов барыге:
можно было сделать несколько заказов барыге, и все они выполнялись, даже если
после выполнения первого заказа у игрока не оставалось денег на остальные.
Пример: броник стоит 15 баксов. Набрать/нагетманить денег на один броник и
заказать больше одного броника. Барыга говорит "!да все".


===== 2005-11-24
Добавлена поддержка скинов.
Новые команды: !setskin, !listskins
Новые ключи !setkey: skin, default_skin
Эти ключи НЕ экспортируются в базу.


===== 2005-11-21
Исправлена ошибка с перерасчетом денег для завербованных ролей, когда маньяк
получал минус деньги за хакера, нарвавшегося на вуду.


===== 2005-11-20
Добавлена возможность уведомлять пользователей в приват о начале регистрации
в игру.
Новая команда: !myregnotify yes|no

_game.pike перешел рубеж 10000 строк. :) Или он это сделал вчера?..


===== 2005-11-19
Исправлен глюк в Game::checkUserLevel() с повторным сообщением
you_can_voice_now при переходе на следующий уровень.

Команду !getmoney можно отключить в демах.
Новый ключ !setkey: disable_getmoney_in_demo_mode = no|yes
В демах со счета не снимаются деньги.

Артефакт "защита от казни" защищает от подставы адвоката.

Девка не отменяет ход сама себе, т.е. может сама себя трахнуть или заразить.


===== 2005-11-16
Телохранитель, начиная со второго уровня, защищает от проверок, девки и хакера.
Телохранитель, начиная со второго уровня, на самом деле защищает клиента от
всех покушений одновременно.

_game.pike перешел рубеж 400K. :)


===== 2005-11-15
В демо-режиме роли выдаются как попало, а не по playersMin.
Новый ключ !setkey: random_roles_in_demo_mode = yes|no

Выбывшим из игры не пишется про выброшенные артефакты в начале ночи.


===== 2005-11-12
Добавлена возможность исключать ники из блокированных адресов.
Новые команды: !addbhe, !delbhe, !listbhe


===== 2005-11-10
Отмена заказа киллеру: !ko отмена
Отмена заказа телохранителю: !go отмена
В списке заказов киллера и телохранителя не показываются ники уже выбывших из
игры.

Подстава адвоката срабатывает при казни завербованных в логово.


===== 2005-11-09
Оттягиваю создание скинов как могу. :)
Артефакты вынесены из файла _classes.pike в отдельный файл _artifacts.pike.
В _classes.pike используется #include "_artifacts.pike".
Косметические исправления в _acl.pike.


===== 2005-11-04
Версия 0.14.

Четвертые уровни ролей.
* Комиссар Каттани: убивает роль (!killrole)
* Бомж: получает команду !kill
* Журналист: выслеживает роль (!stalkrole)
* Адвокат: подставляет роль (!substituterole)
* Маньяк: пассивная защита от казни
* Киллер: пассивная защита от казни, защита от вуду (вторичная), защита от СПИДа
* Телохранитель: защита от вуду (вторичная), защита от СПИДа
* Доктор: может вылечить зараженного девкой игрока
* Девка: клиент не только не ходит ночью, но и не может голосовать днём;
         может отменить дневное голосование, т.е. сразу наступает ночь (!novote)
* Хакер: сбивает заказы всем игрокам, кроме киллера (!totalhack)
* Мафиози: независимый ход ночью.

Изменения у доктора:
* глобал НИКОГДА НЕ лечит от вуду и прямого попадания бомбы

Изменения у барыги:
* добавлена команда !ready, чтобы барыга мог успевать обработать все заказы.

Исправление в Irc::read_callback(). Старый метод проглатывал куски строк,
если сервер присылал их не целиком, т.е. строка не заканчивалась на \r\n.


===== 2005-11-02
Комиссар Каттани умирает, если убивает маньяка НЕ командой !убитьманьяка.
Раньше он мог убить маньяка командой !убить при наличии третьего уровня.

Изменения у киллера третьего уровня:
* глобал доктора не срабатывает
* доктор уровня меньше третьего не спасает жертву
* автопротект девки не срабатывает
* хакер не сбивает заказ
* телохранитель не спасает жертву

Изменения у бомжа:
* !stalk не находит уже проверенные офисом (а не только бомжом) роли
* можно приглашать в офис

Новый ключ !setkey: show_citizen_artifacts_in_casting - показывать ли в конце
игры, у кого из миров был пистолет в игре.


===== 2005-11-01
Добавлена задержка при выводе результатов в конце игры.
Новый ключ: results_show_delay

Выбывшим из игры теперь бот не пишет, что с ними провела ночь девка.


===== 2005-10-31
Используется постоянное соединение с базой.
Настройка в mafion.cfg: mysqlSingleConnection = yes|no


===== 2005-10-30
Подправлен класс Irc. Блок разбивки текста по словам в методе sendline() работал
неправильно. Для разбивки по словам добавлена функция word_wrap().


===== 2005-10-29
Подправлен класс Irc. В метод parseLine() добавлена обработка ситуации,
когда строки с сервера НЕ содержат префикса, а начинаются сразу с кода
сообщения. Из-за таких строк были глюки с юзерлистом (352).
Обработка самих сообщений вынесена в метод processMessage().


===== 2005-10-21
Добавлена возможность замены игроков.
Новые команды: !replace, !replaces
Новые ключи: min_replace_money, replace_price


===== 2005-10-17
Добавлена команда !localtime, показывающая время на машине с ботом
и на машине с с базой.

Добавлена команда !time, показывающая продолжительность игры.


===== 2005-10-11
Добавлена возможность блокировать по адресу.
Новые команды: !blockhost, !unblockhost

Добавлена таблица ERROR_LOG для хранения ошибок.
Новые команды: !lasterror, !errorlog


===== 2005-10-02
Добавлена возможность идентифицироваться под другим ником: !id ник пароль
В СВЯЗИ С ЭТИМ:
* Команда !userinfo переименована в !playerinfo.
* Новая команда !userinfo показывает, под каким ником идентифицировался юзер.
Добавлены команды !whowas и !whomwas. Первая показывает на какие ники идентился
юзер с канала. Вторая показывает какие юзеры идентились на ник в базе.

===== 2005-09-24
Добавлены права на управление группами пользователей.
Обновлён код роли для миров в points.txt и phrases.txt.
Исправлена ошибка "Неизвестная команда!" при дневном голосовании (!ник/!номер).

2005-09-23 17:30:28 -MemoServ-	предложение: если игрок исключается из игры после того как он получил приглашение в офис, но до того как зашел - он все еще может зайти и там остаеться, поэтому было бы правильным сделать чтобы бот кикал таких игроков из офиса

2005-09-23 17:31:42 -MemoServ-	еще ошибка или я просто не понял что делать - не получается с помощью setkey установить REALNAME из нескольких слов

2005-09-23 17:32:09 -MemoServ-	в логе: nick=deopregisteredplayers key=jsergey value=on (nick и key перепутаны местами)


===== 2005-09-21
Добавлена авто-идентификация пользователя при самостоятельной регистрации
ника у бота.


===== 2005-09-11
Добавлена безопасная функция string getMessage(string key), возвращающая
текст сообщения. Рекомендуется юзать её вместо messages[key].

Добавлена смена пользователя и группы бота при запуске.
mafion.cfg:
systemUserName = nobody; 5; system user name
Этот ключ НЕ экспортируется в базу.


Найдена причина порчи списка игроков при использовании shufflePlayers().
Дело в том, что random(mapping) иногда возвращает мусор, а иногда
повторяющиеся значения. С мультисетом таким граблей не замечено, тест
непрерывно работал в течение 20-30 минут. На всякий случай ключ
shufflePlayers пока что оставлен в конфиге.


===== 2005-09-07
Код роли "мирный житель" изменился с "c" на "Z".
Класс rolec переименован в roleZ.


===== 2005-09-03
Добавлена команда !adduser <nick>
Это безусловное добавление игрока в БД (как на сайте).

Добавлена команда !usergroups, позволяющая добавить/удалить
пользователя в/из группы.


===== 2005-09-02
Бот говорит "Неизвестная команда", если нет такой команды.
Также бот рассказывает источники применения команды (приват бота, канал,
логово мафов и т.п.), если команда дана не там, где надо.

Добавлены команды !usertitle1, !usertitle2, !useremail, !userpassword
и !userskippedall, позволяющие операторам изменить титулы, e-mail,
пароль и SKIPPED_ALL пользователя.

Команда !setuser удалена.

Добавлена команда !inviteme, приглашающая пользователя в офис/логово,
если он был туда приглашён.

Команда !allies теперь показывает список союзников завербованным ролям.


===== 2005-09-01
Добавлена команда !settopic, позволяющая задать топик игрового канала.
В базе добавлена таблица CHANNEL_STRINGS, хранящая топики и баннеры.

_mafion.pike:
string topic = "";

_game.pike:
enum ChannelStringType
void saveChannelString()
string loadChannelString()
void setTopic()
void loadTopic()

изменено:
void setBanner()
void loadBanner()

_events.pike:
В void onMode() добавлено:
  if (topic > "") irc->raw(sprintf("TOPIC %s :%s\r\n", settings["gamechannel"]->value, topic));


=====
Добавлен экспорт настроек бота в базу.

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!                                                                             !!!
!!!  ПЕРЕД ЭКСПОРТОМ НАДО ОБНОВИТЬ ВСЕ *.cfg и *.txt ФАЙЛЫ, ВКЛЮЧАЯ mafion.cfg  !!!
!!!                                                                             !!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

В папке db лежат файлы со структурой таблиц. Туда же будут записаны
файлы *.sql с содержимым этих таблиц.

Справка: "_mafion.pike -e" без кавычек.

cfg2db_struct.bat - создание таблиц с настройками.
cfg2db_fill.bat - наполнение таблиц.
cfg2db_struct_and_fill.bat - создание и последующее наполнение таблиц.

Последовательность действий для переноса настроек в базу:
1. Выполнить cfg2db_struct.bat
2. Выполнить _mafion.pike -e all
3. Выполнить cfg2db_fill.bat

Либо:
1. Выполнить _mafion.pike -e all
2. Выполнить cfg2db_struct_and_fill.bat

Файл mafion.cfg.db - это пример конфига при загрузке настроек из базы.
Можно убрать вообще все настройки, НЕ относящиеся к mysql и системному
имени пользователя, под которым работает бот, т.е. оставить только
первые 5 ключей: mysqlServer, mysqlUser, mysqlPassword, mysqlDatabase,
systemUserName.

Файл mafion.cfg.full - это мой полный текущий конфиг. Новые ключи добавлялись
в его конец.

Файл levels.cfg можно удалить за ненадобностью.


=====
Добавлен периодический показ ников именинников.

mafion.cfg:
showBirthdaysInterval = 6; 4; Интервал для показа ников именинников, в часах

commands.cfg:
!O=Прочие команды
  birthdays = 1, mpt, birthdays, др, днирождения, именинники


_events.pike:979:
      if (command == "birthdays") {
         ...
      }

_mafion.pike:74:
   // Таймер поздравления именинников.
   ...

_game.pike:25:
   int        showBirthdaysTimer;

_game.pike:
void timerShowBirthdays()
void showBirthdays()


=====
Копи-пейст - зло.

_game.pike:403:
БЫЛО:
      if (roles["A"]->nick!="" && players[roles["R"]->nick]->alive>=10) s += sprintf("; <r>%s</r>: <n>%s</n>",roles["A"]->name,players[lower(roles["A"]->nick)]->nick());

СТАЛО:
      if (roles["A"]->nick!="" && players[roles["A"]->nick]->alive>=10) s += sprintf("; <r>%s</r>: <n>%s</n>",roles["A"]->name,players[lower(roles["A"]->nick)]->nick());


=====
Реализованы артефакты "блок игрока" (blockplayer) и "блок роли" (blockrole).


=====
Код проверки уровня игрока вынесен в отдельную функцию void checkUserLevel().
Подумал, что переколбашивать каждый раз список всех игроков ради проверки
одного (!getmoney) или двух (Барыга и заказчик) игроков - дороговато в плане
производительности.

Функции void checkUserLevels(), void getMoney() и void completeShopOrder()
соответственно переписаны.

Вообще, наверное, можно было бы сделать void checkUserLevels(mixed ... nicks)
и передавать какие надо ники. Не знаю.


=====
Добавлен параметр shufflePlayers в mafion.cfg. Нужен только на время отладки,
потом будет убран.


=====
Команда !setpassword теперь называется !mypassword.
Старый файл справки setpassword.hlp надо удалить.

Команды !settitle1 и !settitle2 теперь называются !mytitle1 и !mytitle2
соответственно. Старые файлы справки settitle1.hlp и settitle2.hlp надо
удалить.


=====
Добавлена обработка ситуации, когда ник бота уже занят (433 nick in use).
Метод onConnect() переименован в onLogin() - подумал, что так название более
точно соответствует происходящему.


=====
Девка дохнет на мане в дефенде.

Изменения в void morning(), в конце.

_game.pike:831:
БЫЛО:
      if (roles["S"]->orderCommand=="fuckS" || roles["S"]->orderCommand=="infectS") {
         ...
СТАЛО:
      if ((roles["S"]->orderCommand=="fuckS" || roles["S"]->orderCommand=="infectS") 
          && !(roles["S"]->orderNick == roles["M"]->nick && roles["M"]->orderCommand == "protectM")
         )
      {
         ...


=====
Доктор не лечит нарвавшихся на мана в дефенде.

Именения в void checkOrder() в районе // ### Ну и чё там получилось?

_game.pike:1283:
БЫЛО:
         if ((action=="bombF" || action=="voodooM") && players[roles["D"]->nick]->level<3 || action=="voodoo2" || actionCode==110 || (players[lower(killPlayer)] && players[lower(killPlayer)]->alive<10)) {
СТАЛО:
         if (pointsKey == "M:protectok" || (action=="bombF" || action=="voodooM") && players[roles["D"]->nick]->level<3 || action=="voodoo2" || actionCode==110 || (players[lower(killPlayer)] && players[lower(killPlayer)]->alive<10)) {



=====
Решено отказаться от сбора статистики в файле logs/stat.cvs.
В функцию void postLog() в _functions.pike вставлен return в самое начало.



=====
Новая роль - Барыга. http://forum.ircnet.ru/showthread.php?t=397

Файлы shop.cfg и shop.ovr теперь называются artifacts.cfg и artifacts.ovr.

Добавлена загрузка конфига артефактов в main() в _mafion.pike.

Формы слов для функции pieces() из _functions.pike теперь не hard coded,
а находятся в файле pieces.cfg. По этому поводу в _configs.pike добавлена
функция int loadPieces().

roles.cfg:
role = I
name = Барыга
playersMin = 3
repeatOrder = -1
levelsDivider = 10, 10
voiceLevel = 2


prompts.txt:
help_for_i2=Еще немного, и вы сможете узнавать имя заказчика!
help_for_i3=На третьем уровне вы будете узнавать имя заказчика!


points.txt - добавлены очки для Барыги.
phrases.txt - добавлены фразы для Барыги и срабатываний артефактов.


_functions.pike:1:
// data for string pieces() function.
mapping(string:array) pieces_map = ([ ]);

_functions.pike:
string a_join()
string m_join()


_configs.pike:
int loadPieces()
int loadArtifacts()
void loadArtifactsConfig()
void generateArtifactCommand()
ArtifactQuantityDividerType getQuantityDividerType()
ArtifactPermissionsType getArtifactPermissionsType()


_classes.pike:
enum ArtifactQuantityDividerType
enum ArtifactPermissionsType
class Artifact
class ArtifactQuantityDivider
class ArtifactPermissions
class ShopOrder
int getNextShopOrderId()
void resetNextShopOrderId()

_classes.pike:248:
mapping(string:Artifact) artifacts = ([ ]);

_classes.pike:435:
mapping(int:ShopOrder) shopOrders = ([ ]);

_classes.pike:439:
int lastShopOrderId = 0;


Классу Player добавлено свойство artifacts:
_classes.pike:134:
   mapping(string:int) artifacts = ([ ]); // Купленные игроком предметы и их количество.


_game.pike:
enum ShowPointsType
void setArtifact()
void showSetArtifact()
void saveArtifacts()
void buy()
void shop()
void showPlayerInventory()
string getArtifactCode()
string formatArtifactPrice()
string formatArtifactInventoryInfo()
void showOrders()
void showShopOrders()
void showPlayerShopOrders()
void makeShopOrder()
void acceptShopOrder()
void completeShopOrder()
void checkShopOrders()
void cancelShopOrder()
void expireStuff()
void onArtifactCommand()
int artTalk()
int artBlockPlayer()
int artBlockRole()



=====
Добавлена новая команда !setpoints.

Добавлен файл points.ovr.

commands.cfg:
!A=Административные команды
  setpoints = 4, pm, setpoints, sp

messages.txt:
no_such_points_key = Нет такого ключа!
points_changed = points for $NICK changed to $NICK by $NICK
error_writing_points_ovr = Ошибка записи в файл $NICK!

_mafion.pike:56:
   loadPoints("points.ovr");

_events.pike:943:
      if (command == "setpoints") {
         ...
      }

_game.pike:
void setPoints()
void savePoints()

